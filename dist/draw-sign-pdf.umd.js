(function(b,e){typeof exports=="object"&&typeof module!="undefined"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(b=typeof globalThis!="undefined"?globalThis:b||self,e(b["draw-sign-pdf"]={},b.Vue))})(this,function(b,e){"use strict";var je="",Y=(n,o)=>{const l=n.__vccOpts||n;for(const[a,d]of o)l[a]=d;return l};const Q={props:{page:Object},setup(n,{emit:o}){const l=e.ref(null),a=e.ref(0),d=e.ref(0),t=()=>{o("measure",{scale:l.value.clientWidth/a.value})};return e.onMounted(async()=>{const s=await n.page,i=l.value.getContext("2d"),y=s.getViewport({scale:1,rotation:0});a.value=y.width,d.value=y.height,await s.render({canvasContext:i,viewport:y}).promise.then(function(){console.log("Page rendered")}),o("measure",{scale:l.value.clientWidth/a.value}),window.addEventListener("resize",t)}),e.onBeforeUnmount(()=>{window.removeEventListener("resize",t)}),{canvas:l,width:a,height:d}}},X=["width","height"];function V(n,o,l,a,d,t){return e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("canvas",{ref:"canvas",id:"canvas",class:"max-w-full",style:e.normalizeStyle({width:`${a.width}px`}),width:a.width,height:a.height},null,12,X)])}var W=Y(Q,[["render",V],["__scopeId","data-v-415646a0"]]),$="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjUxMnB0IiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgd2lkdGg9IjUxMnB0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiNmNTY1NjUiIGQ9Im00MzcuMDE5NTMxIDc0Ljk4MDQ2OWMtNDguMzUxNTYyLTQ4LjM1MTU2My0xMTIuNjQwNjI1LTc0Ljk4MDQ2OS0xODEuMDE5NTMxLTc0Ljk4MDQ2OXMtMTMyLjY2Nzk2OSAyNi42Mjg5MDYtMTgxLjAxOTUzMSA3NC45ODA0NjljLTQ4LjM1MTU2MyA0OC4zNTE1NjItNzQuOTgwNDY5IDExMi42NDA2MjUtNzQuOTgwNDY5IDE4MS4wMTk1MzEgMCA2OC4zODI4MTIgMjYuNjI4OTA2IDEzMi42Njc5NjkgNzQuOTgwNDY5IDE4MS4wMTk1MzEgNDguMzUxNTYyIDQ4LjM1MTU2MyAxMTIuNjQwNjI1IDc0Ljk4MDQ2OSAxODEuMDE5NTMxIDc0Ljk4MDQ2OXMxMzIuNjY3OTY5LTI2LjYyODkwNiAxODEuMDE5NTMxLTc0Ljk4MDQ2OWM0OC4zNTE1NjMtNDguMzUxNTYyIDc0Ljk4MDQ2OS0xMTIuNjM2NzE5IDc0Ljk4MDQ2OS0xODEuMDE5NTMxIDAtNjguMzc4OTA2LTI2LjYyODkwNi0xMzIuNjY3OTY5LTc0Ljk4MDQ2OS0xODEuMDE5NTMxem0tNzAuMjkyOTY5IDI1Ni4zODY3MTljOS43NjE3MTkgOS43NjU2MjQgOS43NjE3MTkgMjUuNTkzNzUgMCAzNS4zNTU0NjgtNC44ODI4MTIgNC44ODI4MTMtMTEuMjgxMjUgNy4zMjQyMTktMTcuNjc5Njg3IDcuMzI0MjE5cy0xMi43OTY4NzUtMi40NDE0MDYtMTcuNjc5Njg3LTcuMzI0MjE5bC03NS4zNjcxODgtNzUuMzY3MTg3LTc1LjM2NzE4OCA3NS4zNzEwOTNjLTQuODgyODEyIDQuODc4OTA3LTExLjI4MTI1IDcuMzIwMzEzLTE3LjY3OTY4NyA3LjMyMDMxM3MtMTIuNzk2ODc1LTIuNDQxNDA2LTE3LjY3OTY4Ny03LjMyMDMxM2MtOS43NjE3MTktOS43NjU2MjQtOS43NjE3MTktMjUuNTkzNzUgMC0zNS4zNTU0NjhsNzUuMzcxMDkzLTc1LjM3MTA5NC03NS4zNzEwOTMtNzUuMzY3MTg4Yy05Ljc2MTcxOS05Ljc2NTYyNC05Ljc2MTcxOS0yNS41OTM3NSAwLTM1LjM1NTQ2OCA5Ljc2NTYyNC05Ljc2NTYyNSAyNS41OTM3NS05Ljc2NTYyNSAzNS4zNTU0NjggMGw3NS4zNzEwOTQgNzUuMzY3MTg3IDc1LjM2NzE4OC03NS4zNjcxODdjOS43NjU2MjQtOS43NjE3MTkgMjUuNTkzNzUtOS43NjU2MjUgMzUuMzU1NDY4IDAgOS43NjU2MjUgOS43NjE3MTggOS43NjU2MjUgMjUuNTg5ODQ0IDAgMzUuMzU1NDY4bC03NS4zNjcxODcgNzUuMzY3MTg4em0wIDAiLz48L3N2Zz4=",Ee="";const H={props:{originWidth:Number,originHeight:Number,width:Number,x:Number,y:Number,pageScale:{type:Number,default:1},path:String},setup(n,{emit:o}){const l=e.ref(0),a=e.ref(0),d=e.ref(0),t=e.ref(""),s=e.ref(""),i=e.ref(0),y=e.ref(0),p=e.ref(null),g=n.originWidth/n.originHeight;e.onMounted(async()=>{await e.nextTick(),p.value&&p.value.setAttribute("viewBox",`0 0 ${n.originWidth} ${n.originHeight}`)});function h(m){i.value=m.type.startsWith("mouse")?m.clientX:m.touches[0].clientX,y.value=m.type.startsWith("mouse")?m.clientY:m.touches[0].clientY,m.target===m.currentTarget?s.value="move":(s.value="scale",t.value=m.target.dataset.direction)}function x(m){const v=(m.type.startsWith("mouse")?m.clientX:m.touches[0].clientX)-i.value,r=(m.type.startsWith("mouse")?m.clientY:m.touches[0].clientY)-y.value;if(s.value==="move")l.value=v/n.pageScale,a.value=r/n.pageScale;else if(s.value==="scale"){if(t.value==="left-top"){const u=Math.min(v,r*g);l.value=u,d.value=-u,a.value=u/g}if(t.value==="right-bottom"){const u=Math.max(v,r*g);d.value=u}}}function w(){s.value==="move"?(o("update",{x:n.x+l.value,y:n.y+a.value}),l.value=0,a.value=0):s.value==="scale"&&(o("update",{x:n.x+l.value,y:n.y+a.value,width:n.width+d.value,scale:(n.width+d.value)/n.originWidth}),l.value=0,a.value=0,d.value=0,t.value=""),s.value=""}function j(){o("delete")}return{dx:l,dy:a,dw:d,direction:t,operation:s,startX:i,startY:y,svg:p,ratio:g,handlePanStart:h,handlePanMove:x,handlePanEnd:w,onDelete:j}}},R=[e.createElementVNode("div",{"data-direction":"left-top",class:"absolute left-0 top-0 h-4 w-4 -translate-x-1/2 -translate-y-1/2 transform cursor-nwse-resize rounded-full bg-green-400 md:scale-25"},null,-1),e.createElementVNode("div",{"data-direction":"right-bottom",class:"absolute bottom-0 right-0 h-4 w-4 translate-x-1/2 translate-y-1/2 transform cursor-nwse-resize rounded-full bg-green-400 md:scale-25"},null,-1)],G=[e.createElementVNode("img",{class:"h-full w-full",src:$,alt:"delete object"},null,-1)],Z={ref:"svg",width:"100%",height:"100%"},q=["d"];function J(n,o,l,a,d,t){return e.openBlock(),e.createElementBlock("div",{style:e.normalizeStyle({width:`${l.width+a.dw}px`,height:`${(l.width+a.dw)/a.ratio}px`,transform:`translate(${l.x+a.dx}px, ${l.y+a.dy}px)`}),class:"absolute left-0 top-0 select-none"},[e.createElementVNode("div",{onMousedown:o[0]||(o[0]=(...s)=>a.handlePanStart&&a.handlePanStart(...s)),onTouchstart:o[1]||(o[1]=(...s)=>a.handlePanStart&&a.handlePanStart(...s)),onMousemove:o[2]||(o[2]=(...s)=>a.handlePanMove&&a.handlePanMove(...s)),onTouchmove:o[3]||(o[3]=(...s)=>a.handlePanMove&&a.handlePanMove(...s)),onMouseup:o[4]||(o[4]=(...s)=>a.handlePanEnd&&a.handlePanEnd(...s)),onTouchend:o[5]||(o[5]=(...s)=>a.handlePanEnd&&a.handlePanEnd(...s)),class:e.normalizeClass(["absolute h-full w-full cursor-grab border border-dashed border-gray-400",{"cursor-grabbing":a.operation==="move",operation:a.operation}])},R,34),e.createElementVNode("div",{onClick:o[6]||(o[6]=(...s)=>a.onDelete&&a.onDelete(...s)),class:"absolute left-0 right-0 top-0 m-auto h-4 w-4 -translate-y-1/2 transform cursor-pointer rounded-full bg-white md:scale-25"},G),(e.openBlock(),e.createElementBlock("svg",Z,[e.createElementVNode("path",{"stroke-width":"5","stroke-linejoin":"round","stroke-linecap":"round",stroke:"black",fill:"none",d:l.path},null,8,q)],512))],4)}var K=Y(H,[["render",J]]);const ee={setup(n,{emit:o}){const l=e.ref(),a=e.ref([]),d=e.ref(""),t=e.reactive({drawing:!1,x:0,y:0,minX:1/0,minY:1/0,maxX:0,maxY:0}),s=r=>{t.x=r.clientX,t.y=r.clientY;const u=r.target;x({x:t.x,y:t.y,target:u,currentTarget:l.value}),l.value.addEventListener("mousemove",i),l.value.addEventListener("mouseup",y)},i=r=>{const u=r.clientX-t.x,D=r.clientY-t.y;t.x=r.clientX,t.y=r.clientY,w({x:t.x,y:t.y,dx:u,dy:D})},y=r=>{t.x=r.clientX,t.y=r.clientY,j(),l.value.removeEventListener("mousemove",i),l.value.removeEventListener("mouseup",y)},p=r=>{if(r.touches.length>1)return;const u=r.touches[0];t.x=u.clientX,t.y=u.clientY;const D=u.target;x({x:t.x,y:t.y,target:D,currentTarget:l.value}),l.value.addEventListener("touchmove",g),l.value.addEventListener("touchend",h)},g=r=>{if(r.preventDefault(),r.touches.length>1)return;const u=r.touches[0],D=u.clientX-t.x,S=u.clientY-t.y;t.x=u.clientX,t.y=u.clientY,w({x:t.x,y:t.y,dx:D,dy:S})},h=r=>{const u=r.changedTouches[0];t.x=u.clientX,t.y=u.clientY,j(),l.value.removeEventListener("touchmove",g),l.value.removeEventListener("touchend",h)},x=r=>{if(r.target!==r.currentTarget){t.drawing=!1;return}t.drawing=!0,t.x=r.x,t.y=r.y,t.minX=Math.min(t.minX,t.x),t.maxX=Math.max(t.maxX,t.x),t.minY=Math.min(t.minY,t.y),t.maxY=Math.max(t.maxY,t.y),a.value.push(["M",t.x,t.y]),d.value+=`M${t.x},${t.y}`},w=r=>{!t.drawing||(t.x=r.x,t.y=r.y,t.minX=Math.min(t.minX,t.x),t.maxX=Math.max(t.maxX,t.x),t.minY=Math.min(t.minY,t.y),t.maxY=Math.max(t.maxY,t.y),d.value+=`L${t.x},${t.y}`,a.value.push(["L",t.x,t.y]))},j=()=>{t.drawing=!1},m=()=>{var A;if(!a.value.length)return;const r=-(t.minX-10),u=-(t.minY-10),D=t.maxX-t.minX+20,S=t.maxY-t.minY+20;let L="",k=1;D>500&&(k=500/D);const O=a.value.reduce((c,f)=>c+f[0]+(f[1]+r)+","+(f[2]+u),""),T=document.querySelector("svg");if(T){T.removeAttribute("viewBox"),(A=T.querySelector("path"))==null||A.setAttribute("d",O);const c=new XMLSerializer().serializeToString(T);L=btoa(c)}o("finish",{originWidth:D,originHeight:S,path:O,scale:k,signatureImageData:L})},v=()=>{o("cancel")};return e.onMounted(()=>{l.value.addEventListener("mousedown",s),l.value.addEventListener("touchstart",p)}),e.onBeforeUnmount(()=>{l.value.removeEventListener("mousedown",s),l.value.removeEventListener("touchstart",p)}),{signatureCanvas:l,paths:a,path:d,data:t,handlePanStart:x,handlePanMove:w,handlePanEnd:j,finish:m,cancel:v}}},te={style:{height:"50%"},class:"fixed left-0 right-0 top-0 z-10 border-b border-gray-300 bg-white shadow-lg"},ne={class:"absolute bottom-0 right-0 mb-4 mr-4 flex"},ae={class:"pointer-events-none h-full w-full"},oe=["d"];function le(n,o,l,a,d,t){return e.openBlock(),e.createElementBlock("div",te,[e.createElementVNode("div",{ref:"signatureCanvas",onPanstart:o[2]||(o[2]=(...s)=>a.handlePanStart&&a.handlePanStart(...s)),onPanmove:o[3]||(o[3]=(...s)=>a.handlePanMove&&a.handlePanMove(...s)),onPanend:o[4]||(o[4]=(...s)=>a.handlePanEnd&&a.handlePanEnd(...s)),class:"relative h-full w-full select-none"},[e.createElementVNode("div",ne,[e.createElementVNode("button",{onClick:o[0]||(o[0]=(...s)=>a.cancel&&a.cancel(...s)),class:"mr-4 w-24 rounded bg-red-500 px-4 py-1 font-bold text-white hover:bg-red-700"}," Cancel "),e.createElementVNode("button",{onClick:o[1]||(o[1]=(...s)=>a.finish&&a.finish(...s)),class:"w-24 rounded bg-blue-600 px-4 py-1 font-bold text-white hover:bg-blue-700"}," Done ")]),(e.openBlock(),e.createElementBlock("svg",ae,[e.createElementVNode("path",{"stroke-width":"5","stroke-linejoin":"round","stroke-linecap":"round",d:a.path,stroke:"black",fill:"none"},null,8,oe)]))],544)])}var se=Y(ee,[["render",le]]);const C=[{name:"pdfjsLib",src:"https://unpkg.com/pdfjs-dist@2.3.200/build/pdf.min.js"},{name:"PDFLib",src:"https://unpkg.com/pdf-lib@1.4.0/dist/pdf-lib.min.js"},{name:"download",src:"https://unpkg.com/downloadjs@1.4.7"}],P={};function I(n){if(P[n])return P[n];const o=C.find(l=>l.name===n);if(!o)throw new Error(`Script ${n} not exists.`);return B(o)}function B({name:n,src:o}){if(P[n])return P[n];const l=e.ref(null);return P[n]=new Promise((a,d)=>{const t=document.createElement("script");t.src=o,t.onload=()=>{l.value=window[n],console.log(`${n} is loaded.`),a(l)},t.onerror=()=>{d(`The script ${n} didn't load correctly.`),alert("Some scripts did not load correctly. Please reload and try again.")},document.body.appendChild(t)}),l}function re(){C.forEach(B)}async function ie(n,o){const l=await I("pdfjsLib");if(o==="arrayBuffer"){const a=new Blob([n]),d=window.URL.createObjectURL(a);return l.value.getDocument(d).promise}else if(o==="string"){const a="data:application/pdf;base64,"+n;return l.value.getDocument(a).promise}}function ce(){let n=0;return function(){return n++}}async function de(n,o,l){const a=await I("PDFLib"),d=await I("download");let t;try{t=await a.value.PDFDocument.load(n),console.log(t)}catch(i){throw console.log("Failed to load PDF."),i}const s=t.getPages().map(async(i,y)=>{const p=o[y],g=i.getHeight(),h=p.map(async w=>{if(w.type==="drawing"){const{x:j,y:m,path:v,scale:r}=w;console.log(w.scale,"scale","position",j,m);const{pushGraphicsState:u,setLineCap:D,popGraphicsState:S,setLineJoin:L,LineCapStyle:k,LineJoinStyle:O}=a.value;return()=>{i.pushOperators(u(),D(k.Round),L(O.Round)),i.drawSvgPath(v,{borderWidth:5,scale:r,x:j,y:g-m}),i.pushOperators(S())}}});(await Promise.all(h)).forEach(w=>w())});await Promise.all(s);try{const i=await t.save();return console.log(i),d.value(i,l,"application/pdf"),i}catch(i){throw console.log("Failed to save PDF."),i}}var Le="";const ue=e.defineComponent({name:"DrawSignPdf",components:{PDFPage:W,DrawingCanvas:se,Drawing:K},props:{pdfData:String,signatureData:Array},setup(n,{emit:o}){const l=ce(),a=e.ref(null),d=e.ref(""),t=e.ref([]),s=e.ref([]),i=e.ref([]),y=e.ref("Times-Roman"),p=e.ref(null),g=e.ref(-1),h=e.ref(!1),x=e.ref(!1),w=e.ref(""),j=e.ref("");e.onMounted(async()=>{try{I("pdfjsLib"),g.value=0,re(),await v(n.pdfData,"string"),u()}catch(c){console.log(c)}});const m=async c=>{const M=(c.target.files||c.dataTransfer&&c.dataTransfer.files)[0];if(!(!M||M.type!=="application/pdf")){g.value=-1;try{await v(M,"arrayBuffer"),g.value=0}catch(N){console.log(N)}}},v=async(c,f)=>{try{const M=await ie(c,f);d.value=c.name,a.value=c;const N=M.numPages;t.value=Array.from({length:N}).map(async(E,U)=>await M.getPage(U+1)),i.value=Array(N).fill([]),s.value=Array(N).fill({scale:1})}catch(M){throw console.log("Failed to add pdf."),M}},r=async c=>{console.log(c),w.value=c.signatureImageData;const{originWidth:f,originHeight:M,path:N}=c;let E=1;f>500&&(E=500/f),await D(f,M,N,E),x.value=!1},u=()=>{g.value>=0&&(x.value=!0)},D=(c,f,M,N=1)=>{var E,U;i.value=Array(i.value.length).fill([]),console.log((E=n.signatureData)==null?void 0:E.length,n.signatureData),(U=n.signatureData)==null||U.forEach(z=>{const xe=l();N=T(z.width)/c;const Te={id:xe,path:M,type:"drawing",x:T(z.left),y:T(z.top),originWidth:c,originHeight:f,width:T(z.width),scale:N};console.log(T(z.left),"left",T(z.top),"top",T(z.width),"width"),i.value=i.value.map((F,ve)=>z.page===ve+1?[...F,Te]:F)})},S=c=>{g.value=c},L=(c,f)=>{i.value=i.value.map((M,N)=>N==g.value?M.map(E=>E.id===c?{...E,...f}:E):M)},k=c=>{i.value=i.value.map((f,M)=>M==g.value?f.filter(N=>N.id!==c):f)},O=(c,f)=>{s.value[f]=c},T=c=>c*96/2.54*1;return{genID:l,pdfFile:a,pdfName:d,pages:t,pagesScale:s,allObjects:i,currentFont:y,focusId:p,selectedPageIndex:g,saving:h,addingDrawing:x,onUploadPDF:m,addPDF:v,onAddDrawing:u,addDrawing:D,selectPage:S,updateObject:L,deleteObject:k,onMeasure:O,savePDF:async()=>{if(!(!a.value||h.value||!t.value.length)){h.value=!0;try{const c="image/svg+xml";j.value=await de(a.value,i.value,d.value)}catch(c){console.log(c)}finally{h.value=!1}}},onFinishDrawing:r}}}),ge=n=>(e.pushScopeId("data-v-183725ea"),n=n(),e.popScopeId(),n),he={class:"flex min-h-screen flex-col items-center bg-gray-100 py-5"},me={class:"left-0 right-0 top-0 z-10 flex h-12 items-center justify-center"},fe={key:0,"transition:fly":"{ y: -200, duration: 500 }",class:"fixed left-0 right-0 top-0 z-10 border-b border-gray-300 bg-white shadow-lg",style:{height:"50%"}},Me={key:1,class:"w-full"},pe=["onMousedown","onTouchstart"],ye={key:2,class:"flex w-full flex-grow items-center justify-center"},we=[ge(()=>e.createElementVNode("span",{class:"text-3xl font-bold text-gray-500"},"Drag something here",-1))];function Ne(n,o,l,a,d,t){const s=e.resolveComponent("DrawingCanvas"),i=e.resolveComponent("PDFPage"),y=e.resolveComponent("Drawing");return e.openBlock(),e.createElementBlock("div",null,[e.createElementVNode("main",he,[e.createElementVNode("div",me,[e.createElementVNode("button",{onClick:o[0]||(o[0]=(...p)=>n.onAddDrawing&&n.onAddDrawing(...p)),class:"mr-3 w-60 rounded bg-blue-500 px-3 py-1 font-bold text-white hover:bg-blue-700 md:mr-4 md:px-4"}," Update Signature "),e.createElementVNode("button",{onClick:o[1]||(o[1]=(...p)=>n.savePDF&&n.savePDF(...p)),class:e.normalizeClass(["mr-3 w-20 rounded bg-blue-500 px-3 py-1 font-bold text-white hover:bg-blue-700 md:mr-4 md:px-4",{"cursor-not-allowed":n.pages.length===0||n.saving||!n.pdfFile,"bg-blue-700":n.pages.length===0||n.saving||!n.pdfFile}])},e.toDisplayString(n.saving?"Saving":"Save"),3)]),n.addingDrawing?(e.openBlock(),e.createElementBlock("div",fe,[e.createVNode(s,{onFinish:n.onFinishDrawing,onCancel:o[2]||(o[2]=p=>n.addingDrawing=!1)},null,8,["onFinish"])])):e.createCommentVNode("",!0),n.pages.length?(e.openBlock(),e.createElementBlock("div",Me,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.pages,(p,g)=>(e.openBlock(),e.createElementBlock("div",{key:g,class:"flex w-full flex-col items-center overflow-hidden p-5",onMousedown:h=>n.selectPage(g),onTouchstart:h=>n.selectPage(g)},[e.createElementVNode("div",{class:e.normalizeClass(["relative shadow-lg",{"shadow-outline":g===n.selectedPageIndex}])},[e.createVNode(i,{onMeasure:h=>n.onMeasure(h,g),page:p},null,8,["onMeasure","page"]),e.createElementVNode("div",{class:"absolute left-0 top-0 origin-top-left transform",style:e.normalizeStyle({transform:`scale(${n.pagesScale[g].scale})`,touchAction:"none"})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.allObjects[g],h=>{var x;return e.openBlock(),e.createElementBlock("div",{key:h.id},[h.type==="drawing"?(e.openBlock(),e.createBlock(y,{key:0,onUpdate:w=>n.updateObject(h.id,w),onDelete:()=>n.deleteObject(h.id),path:h.path,x:h.x,y:h.y,width:h.width,originWidth:h.originWidth,originHeight:h.originHeight,pageScale:(x=n.pagesScale[g])==null?void 0:x.scale},null,8,["onUpdate","onDelete","path","x","y","width","originWidth","originHeight","pageScale"])):e.createCommentVNode("",!0)])}),128))],4)],2)],40,pe))),128))])):(e.openBlock(),e.createElementBlock("div",ye,we))])])}var _=Y(ue,[["render",Ne],["__scopeId","data-v-183725ea"]]);I("pdfjsLib");const De=n=>{n.component(_.name,_)};_.install=De,b.DrawSignPdf=_,b.default=_,Object.defineProperties(b,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
